---
title: "EPI 569 Final Project"
author: "Meghna Ray, Charlotte Doran, and Bevin Manuelpillai"
date: "`r Sys.Date()`"
output: html_document
execute:
	cache: true
---

### R setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

***Load packages***

```{r}
pacman::p_load(tidyverse, 
               ggplot2,
               janitor,
               lubridate,
               dplyr)
```

### Load data

```{r}
raw_data <- readRDS('rff_finalcases_clean_2023_2.rds') %>% janitor::clean_names()
roster <- readRDS('rosters_569_517_clean_2023_2.rds') %>%  janitor::clean_names()
```

### Data Cleaning

```{r}
linelist <- raw_data %>% 
  #rename variables 
  rename(c('report' = 'reporting_time',
           'infector_id' = 'infectedby',
           'exposure_date' = 'date_of_exposure',
           'exposure_time' = 'time_of_exposure',
           'symptomatic' = 'did_you_have_symptoms',
           'incubation_period' = 'how_many_hours_after_exposure_did_you_develop_symptoms',
           'illness_duration' = 'how_many_hours_after_your_symptom_onset_did_you_feel_better',
           'n_contacts' = 'how_many_people_did_you_expose',
           'n_infect' = 'how_many_people_did_you_actually_infect',
           'contact1_id' = 'case_id_first_exposure',
           'contact1_date' = 'date_of_first_exposure',
           'contact1_time' = 'time_of_first_exposure',
           'contact2_id' = 'case_id_second_exposure',
           'contact2_date' = 'date_of_second_exposure',
           'contact2_time' = 'time_of_second_exposure',
           'contact3_id' = 'case_id_third_exposure',
           'contact3_date' = 'date_of_third_exposure',
           'contact3_time' = 'time_of_third_exposure',
           'contact4_id' = 'case_id_fourth_exposure',
           'contact4_date' = 'date_of_fourth_exposure',
           'contact4_time' = 'time_of_fourth_exposure',
           'contact5_id' = 'case_id_fifth_exposure',
           'contact5_date' = 'date_of_fifth_exposure',
           'contact5_time' = 'time_of_fifth_exposure',
           'exposure0' = 'date_time_exposure',
           'exposure1' = 'date_time_first_exposure',
           'exposure2' = 'date_time_second_exposure',
           'exposure3' = 'date_time_third_exposure',
           'exposure4' = 'date_time_fourth_exposure',
           'exposure5' = 'date_time_fifth_exposure',
  				 'severe_date' = 'date_you_became_severe')) %>% 
  
  #recode gender variable as numeric (0 = Female, 1 = Male, 2 = Non-binary)
  mutate(gender = recode(gender, "Female" = 0, "Male" = 1, "Non-binary" = 2)) %>% 
  
  #recode course variable as numeric (0 = EPI 569, 1 = EPI 517, 2 = both)
  mutate(course = recode(course, "EPI 569 (Concepts and Methods in ID EPI)" = 0, 
                         "EPI/GH 517 (Case Studies in ID)" = 1,
                         "BOTH" = 2)) %>% 
  
  #recode symptomatic variable as numeric (0 = No, 1 = Yes)
  mutate(symptomatic = recode(symptomatic, "No" = 0, "Yes" = 1)) %>% 
	
	#recode severe variable as numeric (0 = No, 1 = Yes)
	mutate(severe = recode(severe, "No" = 0, "Yes" = 1))
  
```

### Plot Epi Curve

***Onset variable***

```{r}
#Create new onset variable using date and time of exposure + incubation period 
med_incubation <- median(linelist$incubation_period, na.rm = TRUE)

linelist <- linelist %>% 
  mutate(onset = ifelse(!is.na(incubation_period),
  											exposure0 + hours(incubation_period),
  											exposure0 + hours(med_incubation))) %>% 
  mutate(onset = date(onset))
```

***Plot epi curve***

```{r}
#Create data frame for epi curve with onset and incidence
epicurve <- as.data.frame(linelist %>% 
                            group_by(onset) %>%
                            summarize(incidence=n()))

#Plot epi curve 
plot1 <- epicurve %>% 
  ggplot(aes(x = onset, y = incidence, labs = FALSE)) + 
  geom_bar(stat="identity", fill="gray45") +
  scale_x_date(date_breaks = "2 days", date_labels = "%m/%d") +
  scale_y_continuous(breaks = seq(0, 15, by = 2)) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  labs(x = "Onset Date",
       y = "Number of Cases",
       title = "Epi Curve for Rollins Fall Fever")
plot1
```

***Plot log cases***

```{r, include = TRUE, echo = T}
epicurve <- epicurve %>% 
  mutate(log_cases = log(incidence))

#Plot log cases
plot2 <- epicurve %>% 
  ggplot(aes(x = onset, y = log_cases, labs = FALSE)) + 
  geom_bar(stat="identity", fill="gray45") +
  scale_x_date(date_breaks = "2 days", date_labels = "%m/%d") +
  scale_y_continuous() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  labs(x = "Exposure Date",
       y = "Log Cases",
       title = "Epi Curve - Log Cases")
plot2
```

***Recovered variable***

```{r}
#Create new recovered variable using date and time of exposure + incubation period + illness duration 
med_duration <- median(linelist$illness_duration, na.rm = TRUE)

linelist <- linelist %>% 
  mutate(recovered = ifelse(!is.na(illness_duration),
  													onset + hours(illness_duration),
  													onset + hours(med_duration))) %>% 
	mutate(recovered = date(recovered))
```

***Calculate number of recovered by day***

```{r}
recovered <- linelist %>% 
  group_by(recovered) %>% 
  summarize(n_recovered = n()) %>% 
  na.omit()
```

***Calculate number of infected by day***

```{r}
infected <- linelist %>%
  group_by(onset) %>%
  summarize(n_onset = n()) %>%
  na.omit()

#Create a sequence of dates from the onset to the end of the outbreak
dateseq <- seq(from = as.Date(min(linelist$onset, na.rm = TRUE)),
								 to = as.Date(max(linelist$recovered, na.rm = TRUE)),
								 by = "1 day")

#For each date, calculate the number of infected people by determining if that date is between their onset date and their recovery date
infectedseq <- map(dateseq, ~sum(.x >= linelist$onset & .x < linelist$recovered, na.rm = TRUE))
infected2 <- data.frame(date = dateseq, n_infected = as.numeric(infectedseq))
```

***Calculate number of susceptible by day***

```{r}

#Join infected and recovered datasets
epicurve2 <- infected2 %>% 
  full_join(recovered, by =c('date' = 'recovered')) %>%
	full_join(infected, by = c("date" = "onset"))

#Set na values to zero 
epicurve2 <- epicurve2 %>% 
  mutate(n_infected = ifelse(is.na(n_infected), 0, n_infected)) %>% 
  mutate(n_recovered = ifelse(is.na(n_recovered), 0, n_recovered)) %>% 
	mutate(n_onset = ifelse(is.na(n_onset), 0, n_onset))

#Create variable for cumulative recoveries and infected
epicurve2 <- epicurve2 %>% 
  mutate(total_recovered = cumsum(n_recovered)) %>% 
  mutate(total_infected = cumsum(n_onset))

#Calculate number of people not susceptible and susceptible 
total_pop <- nrow(roster)
epicurve2 <- epicurve2 %>% 
  mutate(susceptible = total_pop - total_infected)
```

***Plot susceptible, infected, and recovered by day***

```{r}
plot2 <- ggplot(epicurve2, aes(x = date)) +
  geom_line(aes(y = susceptible, color = "Susceptible")) +
  geom_line(aes(y = n_infected, color = "Infected")) +
  geom_line(aes(y = total_recovered, color = "Recovered")) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  labs(x = "Date",
       y = "Number of Cases",
       title = "Epi Curve for Rollins Fall Fever") +
  scale_color_manual(name='Class',
                     breaks=c('Susceptible', 'Infected', 'Recovered'),
                     values=c('Susceptible'='red', 'Infected'='blue', 'Recovered'='green')) +
  theme(legend.title = element_text(size = 15),
        legend.text = element_text(size = 8))

plot2
```

***Wanted to see how a percent Epi Curve would look. I havent seen the data presented this way in class though***

```{r}
epicurve3 <- epicurve2 %>% 
	mutate(susceptible2 = susceptible/153) %>% 
	mutate(n_infected2 = n_infected/153) %>% 
	mutate(total_recovered2 = total_recovered/153)

plot3 <- ggplot(epicurve3, aes(x = date)) +
  geom_line(aes(y = susceptible2, color = "Susceptible")) +
  geom_line(aes(y = n_infected2, color = "Infected")) +
  geom_line(aes(y = total_recovered2, color = "Recovered")) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  labs(x = "Date",
       y = "Proportion of Total Population",
       title = "Epi Curve for Rollins Fall Fever") +
  scale_color_manual(name='Class',
                     breaks=c('Susceptible', 'Infected', 'Recovered'),
                     values=c('Susceptible'='red', 'Infected'='blue', 'Recovered'='green')) +
  theme(legend.title = element_text(size = 15),
        legend.text = element_text(size = 8))

plot3
```

**Plot epi curve using exposure date rather than onset date**

```{r}
epicurve4 <- as.data.frame(linelist %>% 
                            group_by(exposure_date) %>%
                            summarize(incidence=n()))

#Plot epi curve 
plot4 <- epicurve4 %>% 
  ggplot(aes(x = exposure_date, y = incidence, labs = FALSE)) + 
  geom_bar(stat="identity", fill="gray45") +
  scale_x_date(date_breaks = "2 days", date_labels = "%m/%d") +
  scale_y_continuous(breaks = seq(0, 15, by = 2)) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  labs(x = "Exposure Date",
       y = "Number of Cases",
       title = "Epi Curve for Rollins Fall Fever")
plot4
```

## Modeling

RFF confers complete immunity among those who recovered. Additionally, no new students entered the population during the outbreak, and no deaths occurred among susceptible individuals or asymptomatic individuals. The dynamics of this RFF outbreak can be described with the following set of equations.

$\frac{dS}{dt} = -\lambda_t S$

$\frac{dI_s}{dt} = \lambda_t S - \sigma_s I_s - \mu_s I_s$

$\frac{dI_a}{dt} = \lambda_t S - \sigma_a I_a$ (*not sure if lambda term should be the same or different)

$\frac{dR}{dt} = \sigma_s I_s + \sigma_a I_a$

Where $\lambda_t$ is the force of infection, $\sigma$ is the recovery rate among infected individuals, and $\mu$ is the "death" rate among infected individuals (i.e. the rate at which cases became severe).

Questions:

-   Is the recovery rate the same among symptomatic vs. asymptomatic cases?

-   Do all the deaths occur among infected individuals? Several severe dates occur after the calculated recovery date based on the illness duration reported.


### Caluclate critical vaccination thresholds

$P_c = (1 - 1/R_0) / VE$ 

$HIT = (1 - 1/R_0)$ 

$P_c = HIT / VE$ 

$R_0 = 2.41$ 

```{r}

R0 <- 2.41 
HIT <- 1 - (1/R0)
HIT

#VE = 100%
Pc_100 <- (HIT/1) *100
Pc_100

#VE = 90% 
Pc_90 <- (HIT/0.9) *100
Pc_90

#VE = 80% 
Pc_80 <- (HIT/0.8) *100
Pc_80

#VE = 70%
Pc_70 <- (HIT/0.7) *100
Pc_70

#VE = 60%
Pc_60 <- (HIT/0.6) *100
Pc_60

#VE = 50%
Pc_50 <- (HIT/0.5) *100
Pc_50

#VE = 50%
Pc_40 <- (HIT/0.4) *100
Pc_40

```

### Time Varying Reproductive Number 
```{r setup, include = FALSE}
library(dplyr, warn.conflicts=F, quietly=T)
library(ggplot2, warn.conflicts=F, quietly=T)
library(EpiEstim, warn.conflicts=F, quietly=T)
library(ggpubr)
```


```{r, echo = TRUE}
# First, convert the data to a format that can be used in the EpiEstim wallinga_teunis function 
# Data must be in the following format: 
### 1 column for symptom onset dates in ascending order, including dates on which 0 cases were reported, titled "dates"
### 1 column for case counts (incidence) titled "I"
### Note: to calculate an Rt estimate for day day 1 of the outbreak, we must start our epi curve 2 days prior the first symptom onset date

epicurve2 <- epicurve %>% arrange(onset_date) %>% rename(dates = onset_date, I = incidence)

all.dates <- as.data.frame(seq(as.Date("2019-10-14"), by = "day", length.out = 45))
names(all.dates) <- "dates"

epicurve.epiestim <- merge(x=epicurve2, y=all.dates, by="dates", all="TRUE")
epicurve.epiestim <- epicurve.epiestim %>% mutate(I = ifelse(is.na(I), 0, I)) 


# Next, run the code below to estimate Rt, along with 95% confidence intervals for Rt estimates
# This requires that we specify the mean and standard deviation of the serial interval  
# An offset gamma distribution will be used for the serial interval (by default)

mean_si <- 3.6   
std_si <- 2.0

estimates <- wallinga_teunis(epicurve.epiestim$I, 
                             method="parametric_si",
                             config = list(t_start = seq(3, 45), 
                                           t_end = seq(3, 45),
                                           mean_si = mean_si, 
                                           std_si = std_si, 
                                           n_sim = 1000))


# You can examine the serial interval distribution using the code below

plot(estimates$si_distr, xlab="Serial Interval (Days)", ylab="Proportion")
```


```{r, echo = TRUE}
plot2.data <- cbind(epicurve, estimates$R$`Mean(R)`,
                    estimates$R$`Quantile.0.025(R)`, estimates$R$`Quantile.0.975(R)`)
names(plot2.data) <- c("dates", "I", "R", "lowerCI", "upperCI")

plot2 <- ggplot(data=plot2.data, aes(x=dates, y=I, labs=FALSE)) + 
  geom_bar(stat="identity", fill="gray45") +
  scale_x_date(date_breaks = "2 days", date_labels = "%m/%d") +
  scale_y_continuous(breaks = seq(0,15, by = 2)) +
  theme(axis.text.x = element_text(angle = 45)) +
  labs(x = "Symptom Onset Date", 
       y = "Number of Cases (bars) and Rt (line;95% CI)",
       title = "Epi Curve for Rushmore Academy Norovirus Outbreak (mean SI=3.6)") +
  geom_hline(aes(yintercept=1), colour="red", linetype="dashed", size=0.5) +
  geom_errorbar(data=plot2.data, aes(ymax=upperCI, ymin=lowerCI, width=0.6),stat="identity", size=0.8, show.legend=FALSE) +
  geom_line(data=plot2.data[!is.na(plot2.data$R),],aes(x=dates, y=R), color='blue', size=0.5) +
  geom_point(data = plot2.data, aes(x=dates, y=R), size=1.2, show.legend=FALSE) 
plot2
```
