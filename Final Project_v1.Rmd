---
title: "EPI 569 Final Project"
author: "Meghna Ray, Charlotte Doran, and Bevin Manuelpillai"
date: "`r Sys.Date()`"
output: html_document
execute:
	cache: true
---

### R setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

***Load packages***

```{r}
pacman::p_load(tidyverse, 
               ggplot2,
               janitor,
               lubridate,
               dplyr,
							 splitstackshape,
							 earlyR,
							 incidence)
```

### Load data

```{r}
raw_data <- readRDS('rff_finalcases_clean_2023_2.rds') %>% janitor::clean_names()
roster <- readRDS('rosters_569_517_clean_2023_2.rds') %>%  janitor::clean_names()
```

### Data Cleaning

```{r}
linelist <- raw_data %>% 
  #rename variables 
  rename(c('report' = 'reporting_time',
           'infector_id' = 'infectedby',
           'exposure_date' = 'date_of_exposure',
           'exposure_time' = 'time_of_exposure',
           'symptomatic' = 'did_you_have_symptoms',
           'incubation_period' = 'how_many_hours_after_exposure_did_you_develop_symptoms',
           'illness_duration' = 'how_many_hours_after_your_symptom_onset_did_you_feel_better',
           'n_contacts' = 'how_many_people_did_you_expose',
           'n_infect' = 'how_many_people_did_you_actually_infect',
           'contact1_id' = 'case_id_first_exposure',
           'contact1_date' = 'date_of_first_exposure',
           'contact1_time' = 'time_of_first_exposure',
           'contact2_id' = 'case_id_second_exposure',
           'contact2_date' = 'date_of_second_exposure',
           'contact2_time' = 'time_of_second_exposure',
           'contact3_id' = 'case_id_third_exposure',
           'contact3_date' = 'date_of_third_exposure',
           'contact3_time' = 'time_of_third_exposure',
           'contact4_id' = 'case_id_fourth_exposure',
           'contact4_date' = 'date_of_fourth_exposure',
           'contact4_time' = 'time_of_fourth_exposure',
           'contact5_id' = 'case_id_fifth_exposure',
           'contact5_date' = 'date_of_fifth_exposure',
           'contact5_time' = 'time_of_fifth_exposure',
           'exposure0' = 'date_time_exposure',
           'exposure1' = 'date_time_first_exposure',
           'exposure2' = 'date_time_second_exposure',
           'exposure3' = 'date_time_third_exposure',
           'exposure4' = 'date_time_fourth_exposure',
           'exposure5' = 'date_time_fifth_exposure',
  				 'severe_date' = 'date_you_became_severe')) %>% 
  
  #recode gender variable as numeric (0 = Female, 1 = Male, 2 = Non-binary)
  mutate(gender = recode(gender, "Female" = 0, "Male" = 1, "Non-binary" = 2)) %>% 
  
  #recode course variable as numeric (0 = EPI 569, 1 = EPI 517, 2 = both)
  mutate(course = recode(course, "EPI 569 (Concepts and Methods in ID EPI)" = 0, 
                         "EPI/GH 517 (Case Studies in ID)" = 1,
                         "BOTH" = 2)) %>% 
  
  #recode symptomatic variable as numeric (0 = No, 1 = Yes)
  mutate(symptomatic = recode(symptomatic, "No" = 0, "Yes" = 1)) %>% 
	
	#recode severe variable as numeric (0 = No, 1 = Yes)
	mutate(severe = recode(severe, "No" = 0, "Yes" = 1))
  
```

### Plot Epi Curve

***Onset and recovered variable***

```{r}
med_incubation <- median(linelist$incubation_period, na.rm = TRUE)
med_duration <- median(linelist$illness_duration, na.rm = TRUE)
asymp_duration <- med_incubation + med_duration

#Create onset variable
linelist <- linelist %>% 
	mutate(onset = case_when(symptomatic == 0 ~ NA, #no symptom onset for asymptomatic cases
													 symptomatic == 1 ~ exposure0 + hours(incubation_period), #symptoms start after incubation period
													 is.na(symptomatic) ~ NA, #keep missing and NA's NA
													 TRUE ~ NA)) %>% 
  mutate(onset = date(onset))

#Create recovered variable
linelist <- linelist %>% 
	mutate(recovered = case_when((symptomatic == 0 | is.na(symptomatic)) ~ exposure0 + hours(asymp_duration), #imputed infectious periods for asymptomatic or missing
															 (symptomatic == 1 & severe == 1) ~ pmax(onset + hours(illness_duration), severe_date), #for severe cases, recovery is the later of illness duration end or severe date
															 (symptomatic == 1 & severe == 0) ~ onset + hours(illness_duration),
															 TRUE ~ NA)) %>% 
	mutate(recovered = date(recovered))

```

***Plot epi curve***

```{r}
#Create data frame for epi curve with exposure date and incidence
epicurve <- as.data.frame(linelist %>% 
                            group_by(exposure_date) %>%
                            summarize(incidence=n()))

#Plot epi curve 
plot1 <- epicurve %>% 
  ggplot(aes(x = exposure_date, y = incidence, labs = FALSE)) + 
  geom_bar(stat="identity", fill="gray45") +
  scale_x_date(date_breaks = "2 days", date_labels = "%m/%d") +
  scale_y_continuous(breaks = seq(0, 15, by = 2)) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  labs(x = "Exposure Date",
       y = "Number of Cases",
       title = "Epi Curve for Rollins Fall Fever")
plot1
```

***Plot log cases***

```{r, include = TRUE, echo = T}
epicurve <- epicurve %>% 
  mutate(log_cases = log(incidence))

#Plot log cases
plot2 <- epicurve %>% 
  ggplot(aes(x = exposure_date, y = log_cases, labs = FALSE)) + 
  geom_bar(stat="identity", fill="gray45") +
  scale_x_date(date_breaks = "2 days", date_labels = "%m/%d") +
  scale_y_continuous() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  labs(x = "Exposure Date",
       y = "Log Cases",
       title = "Epi Curve - Log Cases")
plot2
```

***Calculate number of recovered by day***

```{r}
recovered <- linelist %>% 
  group_by(recovered) %>% 
  summarize(n_recovered = n()) %>% 
  na.omit()
```

***Calculate number of infected by day***

```{r}
infected <- linelist %>%
  group_by(exposure_date) %>%
  summarize(n_exposed = n()) %>%
  na.omit()

#Create a sequence of dates from the onset to the end of the outbreak
dateseq <- seq(from = as.Date(min(linelist$exposure_date, na.rm = TRUE)),
								 to = as.Date(max(linelist$recovered, na.rm = TRUE)),
								 by = "1 day")

#For each date, calculate the number of infected people by determining if that date is between their onset date and their recovery date
infectedseq <- map(dateseq, ~sum(.x >= linelist$exposure_date & .x < linelist$recovered, na.rm = TRUE))
infected2 <- data.frame(date = dateseq, n_infected = as.numeric(infectedseq))
```

***Calculate number of susceptible by day***

```{r}

#Join infected and recovered datasets
epicurve2 <- infected2 %>% 
  full_join(recovered, by = c("date" = "recovered")) %>% 
	full_join(infected, by = c("date" = "exposure_date")) %>% 
	#Set na values to zero 
  mutate(n_infected = ifelse(is.na(n_infected), 0, n_infected)) %>% 
  mutate(n_recovered = ifelse(is.na(n_recovered), 0, n_recovered)) %>% 
	mutate(n_exposed = ifelse(is.na(n_exposed), 0, n_exposed)) %>% 
	#Create variable for cumulative recoveries and infected
  mutate(total_recovered = cumsum(n_recovered)) %>% 
  mutate(total_infected = cumsum(n_exposed))

#Calculate number of people susceptible 
total_pop <- nrow(roster)
epicurve2 <- epicurve2 %>% 
  mutate(n_susceptible = total_pop - total_infected) %>% 
	#Check that the total population size is stable
	mutate(total = n_infected + total_recovered + n_susceptible)
```

***Plot susceptible, infected, and recovered by day***

```{r}
plot3 <- ggplot(epicurve2, aes(x = date)) +
  geom_line(aes(y = n_susceptible, color = "Susceptible"), linewidth = 1) +
  geom_line(aes(y = n_infected, color = "Infected"), linewidth = 1) +
  geom_line(aes(y = total_recovered, color = "Recovered"), linewidth = 1) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  labs(x = "Date",
       y = "Number of Cases",
       title = "Epi Curve for Rollins Fall Fever") +
  scale_color_manual(name='Class',
                     breaks=c('Susceptible', 'Infected', 'Recovered'),
                     values=c('Susceptible'='red', 'Infected'='blue', 'Recovered'='green')) +
	scale_x_date(breaks = "2 days",
							 date_labels = "%b %d") +
  theme(legend.title = element_text(size = 15),
        legend.text = element_text(size = 8),
  			panel.grid.minor = element_blank())

plot3
```

***Wanted to see how a percent Epi Curve would look. I havent seen the data presented this way in class though***

```{r}
epicurve3 <- epicurve2 %>% 
	mutate(susceptible2 = susceptible/153) %>% 
	mutate(n_infected2 = n_infected/153) %>% 
	mutate(total_recovered2 = total_recovered/153)

plot4 <- ggplot(epicurve3, aes(x = date)) +
  geom_line(aes(y = susceptible2, color = "Susceptible")) +
  geom_line(aes(y = n_infected2, color = "Infected")) +
  geom_line(aes(y = total_recovered2, color = "Recovered")) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  labs(x = "Date",
       y = "Proportion of Total Population",
       title = "Epi Curve for Rollins Fall Fever") +
  scale_color_manual(name='Class',
                     breaks=c('Susceptible', 'Infected', 'Recovered'),
                     values=c('Susceptible'='red', 'Infected'='blue', 'Recovered'='green')) +
  theme(legend.title = element_text(size = 15),
        legend.text = element_text(size = 8))

plot4
```

**Plot epi curve using only symptom onset dates for observed (symptomatic) cases**

```{r}
epicurve4 <- as.data.frame(linelist %>% 
													 	filter(symptomatic == 1) %>% 
                            group_by(onset) %>%
                            summarize(incidence=n()))

#Plot epi curve 
plot5 <- epicurve4 %>% 
  ggplot(aes(x = onset, y = incidence, labs = FALSE)) + 
  geom_bar(stat="identity", fill="gray45") +
  scale_x_date(date_breaks = "2 days", date_labels = "%b %d") +
  scale_y_continuous(breaks = seq(0, 15, by = 2)) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  labs(x = "Symptom Onset Date",
       y = "Number of Cases",
       title = "Epi Curve for Rollins Fall Fever")
plot5
```

## Natural History



## Reproduction Numbers
```{r}
start_day <- date("2023-10-11")
end_day <- date("2023-10-20")
```

We used the initial growth rate method to calculate $R_0$ from the plot of the log cases based on exposure date. The first case on RFF was observed on `r start_day`. Using the plot of log cases, the log-linear growth period ends on `r end_day`.

$I(t) \approx I(0) e^{rt}$

```{r}
linear_growth <- epicurve %>% 
	filter(exposure_date %in% c(start_day, end_day))

plot2 +
	geom_line(data = linear_growth,
						mapping = aes(x = exposure_date, y = log_cases),
						color = "darkred",
						linewidth = 1.5)
```
```{r}
r0_df <- epicurve %>%
	filter(exposure_date >= start_day, exposure_date <= end_day) %>% 
	splitstackshape::expandRows("incidence", drop = FALSE) %>% 
	select(exposure_date) %>% 
	pull(exposure_date)

i <- incidence(r0_df)
mu <- 1.81 #replace with mean generation time
sigma <- 2.18 #replace with standard deviation of generation time

res <- get_R(i, si_mean = mu, si_sd = sigma)
R_val <- sample_R(res, 1000)
r0 <- mean(R_val)
```

Based on the initial growth rate, the basic reproductive number for RFF, $R_0$, is `r round(r0, 1)`.

We can compare this value to the $R_0$ calculated based purely on the number of people that each individual exposed.

```{r}
r0_2 <- mean(linelist$n_contacts)
```


## Modeling

RFF confers complete immunity among those who recovered. Additionally, no new students entered the population during the outbreak, and no deaths occurred among susceptible individuals or asymptomatic individuals. The dynamics of this RFF outbreak can be described with the following set of equations.

$\frac{dS}{dt} = -\lambda_t S$

$\frac{dI_s}{dt} = \lambda_t S - \sigma_s I_s - \mu_s I_s$

$\frac{dI_a}{dt} = \lambda_t S - \sigma_a I_a$ (*not sure if lambda term should be the same or different)

$\frac{dR}{dt} = \sigma_s I_s + \sigma_a I_a$

Where $\lambda_t$ is the force of infection, $\sigma$ is the recovery rate among infected individuals, and $\mu$ is the "death" rate among infected individuals (i.e. the rate at which cases became severe).

Questions:

-   Is the recovery rate the same among symptomatic vs. asymptomatic cases?

-   Do all the deaths occur among infected individuals? Several severe dates occur after the calculated recovery date based on the illness duration reported.
